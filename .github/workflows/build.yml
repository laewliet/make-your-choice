name: Build for Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zsh libgtk-4-dev pkg-config build-essential

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify toolchain (Linux)
        run: |
          zsh --version
          rustc --version
          cargo --version

      - name: Read version
        run: |
          VERSION=$(sed -n 's/^version:[[:space:]]*//p' VERSINF.yml | head -n1)
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Build (Linux)
        working-directory: linux
        run: zsh build.zsh

      - name: Package (Linux)
        run: |
          mkdir -p dist
          cp linux/target/release/make-your-choice "dist/MakeYourChoice-${VERSION}-Linux"

      - name: Upload to Release (Linux)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/MakeYourChoice-${{ env.VERSION }}-Linux

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Verify .NET (Windows)
        shell: pwsh
        run: dotnet --version

      - name: Read version
        shell: pwsh
        run: |
          $versionLine = Get-Content VERSINF.yml | Select-String '^version:' | Select-Object -First 1
          if (-not $versionLine) { throw 'version not found in VERSINF.yml' }
          $version = $versionLine.Line -replace '^version:\s*', ''
          Add-Content $env:GITHUB_ENV "VERSION=$version"

      - name: Build (Windows)
        working-directory: win
        shell: pwsh
        run: ./build.ps1

      - name: Package (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $dest = "dist/MakeYourChoice-$env:VERSION-Win.exe"
          Copy-Item -Path win/bin/Release/net10.0-windows/win-x64/publish/MakeYourChoice.exe -Destination $dest

      - name: Upload to Release (Windows)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/MakeYourChoice-${{ env.VERSION }}-Win.exe
